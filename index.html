<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShowTails OCR Pedigree Scanner</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background-color: #f9fafb;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #333;
      margin-bottom: 0.5em;
    }
    #preview {
      margin-top: 15px;
      max-width: 90%;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    #progress {
      margin-top: 10px;
      color: #555;
    }
    #output {
      white-space: pre-wrap;
      text-align: left;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 15px;
      border-radius: 10px;
      font-family: monospace;
      max-height: 60vh;
      overflow: auto;
      background: #fff;
    }
  </style>
</head>
<body>

  <h1>üêá ShowTails OCR Pedigree Scanner</h1>
  <p>The image from Glide will be processed automatically. Once complete, copy the text below and paste it into Glide.</p>

  <div id="progress">Scanning...</div>
  <img id="preview" alt="Pedigree preview" />
  <div id="output"></div>

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    async function runOCR(imageUrl, progressEl, outputEl) {
      function updateProgress(m) {
        if (m.status === 'recognizing text') {
          progressEl.textContent = `Scanning: ${(m.progress * 100).toFixed(1)}%`;
        }
      }

      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.src = imageUrl;
      await img.decode();

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const W = img.naturalWidth;
      const H = img.naturalHeight;
      canvas.width = W;
      canvas.height = H;
      ctx.drawImage(img, 0, 0);

      // --- Preprocess for better OCR ---
      const imageData = ctx.getImageData(0, 0, W, H);
      const dataArr = imageData.data;
      for (let i = 0; i < dataArr.length; i += 4) {
        const avg = (dataArr[i] + dataArr[i + 1] + dataArr[i + 2]) / 3;
        const val = avg > 180 ? 255 : 0;
        dataArr[i] = dataArr[i + 1] = dataArr[i + 2] = val;
      }
      ctx.putImageData(imageData, 0, 0);

      const generations = [
        { name: "Rabbit", x: 0, w: W * 0.22 },
        { name: "Parents", x: W * 0.22, w: W * 0.24 },
        { name: "Grandparents", x: W * 0.46, w: W * 0.26 },
        { name: "GreatGrandparents", x: W * 0.72, w: W * 0.28 }
      ];

      // --- Create worker with explicit paths (fix for embedded browser) ---
      const worker = await Tesseract.createWorker({
        workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js',
        langPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/lang/',
        corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@5/dist/tesseract-core.wasm.js',
        logger: updateProgress
      });

      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      await worker.setParameters({
        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_COLUMN,
        preserve_interword_spaces: '1'
      });

      let combinedText = '';
      let confidences = [];

      for (let g of generations) {
        const crop = document.createElement('canvas');
        crop.width = g.w;
        crop.height = H;
        const cctx = crop.getContext('2d');
        cctx.drawImage(img, g.x, 0, g.w, H, 0, 0, g.w, H);

        const { data } = await worker.recognize(crop);
        combinedText += `\n\n=== ${g.name.toUpperCase()} ===\n\n` + data.text;
        if (data.confidence) confidences.push(data.confidence);
      }

      await worker.terminate();

      const avgConf = confidences.length
        ? (confidences.reduce((a, b) => a + b, 0) / confidences.length).toFixed(1)
        : 'N/A';

      outputEl.innerText =
        `‚úÖ OCR complete ‚Äî Average Confidence: ${avgConf}%\nCopy and paste this text into Glide:\n\n${combinedText}`;

      progressEl.textContent = '‚úÖ OCR finished successfully.';
    }

    const params = new URLSearchParams(location.search);
    const imageUrl = params.get('image');
    const progress = document.getElementById('progress');
    const output = document.getElementById('output');
    const preview = document.getElementById('preview');

    if (imageUrl) {
      preview.src = imageUrl;
      runOCR(imageUrl, progress, output).catch(err => {
        progress.textContent = '‚ùå OCR failed: ' + (err?.message || err);
        console.error(err);
      });
    } else {
      progress.textContent = '‚ùå No image URL detected. Add ?image= to your link.';
    }
  </script>
</body>
</html>
